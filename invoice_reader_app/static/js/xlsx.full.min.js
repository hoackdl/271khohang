document.getElementById('exportExcelBtn').addEventListener('click', function () {
  const table = document.getElementById('invoiceTable');
  if (!table) {
    alert('Không tìm thấy bảng dữ liệu!');
    return;
  }

  const headers = [
    'File','Tên gọi mới file hoá đơn', 'Ký hiệu', 'Mẫu số', 'Số hoá đơn', 'Ngày tháng hoá đơn',
    'Hình thức TT ghi trên HĐ', 'Tên đơn vị bán', 'Mã số thuế', 'Địa chỉ',
    'Nội dung HĐ', 'Đơn vị tính', 'Số lượng', 'Đơn giá', 'Thành tiền',
    'Thuế suất', 'Tiền thuế GTGT', 'Tổng tiền TT'
  ];

  const data = [headers];
  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(tr => {
  const tds = Array.from(tr.querySelectorAll('td'));
  if (!tds.length) return;

  const row = [];

  // Cột 1: File gốc, bỏ .xml nếu có
  let fileName = tds[1]?.getAttribute('title')?.trim() || tds[1]?.textContent.trim() || '';
  if (fileName.endsWith('.xml')) {
    fileName = fileName.slice(0, -4);
  }
  row[0] = fileName;

  
  row[3] = tds[3]?.textContent.trim() || ''; // Mẫu số
  row[2] = tds[2]?.textContent.trim() || ''; // Ký hiệu
  row[4] = (tds[4]?.textContent.trim() || '').padStart(8, '0'); // Số hoá đơn
  function formatToDDMMYY(str) {
  if (!str) return '';
  const dateParts = str.split(/[-\/]/); // phân tách theo '-' hoặc '/'
  let dd, mm, yy;

    if (str.includes('/')) { // dd/mm/yyyy
      dd = dateParts[0].padStart(2, '0');
      mm = dateParts[1].padStart(2, '0');
      yy = dateParts[2].slice(-2);
    } else { // yyyy-mm-dd
      dd = dateParts[2].padStart(2, '0');
      mm = dateParts[1].padStart(2, '0');
      yy = dateParts[0].slice(-2);
    }

    return `${dd}/${mm}/${yy}`;
  }

  // Sử dụng khi lấy dữ liệu
  row[5] = formatToDDMMYY(tds[5]?.textContent.trim() || '');

  row[6] = tds[6]?.textContent.trim() || ''; // Hình thức TT
  row[7] = tds[7]?.getAttribute('title')?.trim() || tds[7]?.textContent.trim() || ''; // Tên đơn vị bán
  row[8] = (tds[8]?.textContent.trim() || '').toString(); // Mã số thuế
  row[9] = tds[9]?.getAttribute('title')?.trim() || tds[9]?.textContent.trim() || ''; // Địa chỉ
  row[10] = tds[10]?.textContent.trim() || ''; // Nội dung HĐ
  row[11] = tds[11]?.textContent.trim() || ''; // Đơn vị tính

  function parseNumber(str) {
    if (!str) return 0;
    return parseFloat(str.replace(/,/g, '').trim()) || 0;
  }

  row[12] = parseNumber(tds[12]?.textContent); // Số lượng
  row[13] = parseNumber(tds[13]?.textContent); // Đơn giá
  row[14] = parseNumber(tds[14]?.textContent); // Thành tiền
  row[15] = tds[15]?.textContent.trim() || ''; // Thuế suất
  row[16] = parseNumber(tds[16]?.textContent); // Tiền thuế GTGT
  row[17] = parseNumber(tds[17]?.textContent); // Tổng tiền TT

  // Tạo tên gọi mới file hoá đơn (cột 2)
  function formatDateToYYMMDD(str) {
    if (!str) return '';
    const dateParts = str.split(/[-\/]/);
    if (dateParts.length < 3) return '';
    let dd, mm, yy;
    if (str.includes('/')) { // dd/mm/yyyy
      dd = dateParts[0].padStart(2,'0');
      mm = dateParts[1].padStart(2,'0');
      yy = dateParts[2].slice(-2);
    } else { // yyyy-mm-dd
      dd = dateParts[2].padStart(2,'0');
      mm = dateParts[1].padStart(2,'0');
      yy = dateParts[0].slice(-2);
    }
    return `${yy}_${mm}_${dd}`;
  }

  const datePart = formatDateToYYMMDD(row[5]);
  const maDonVi = row[8] || '';
  const kyHieu = row[2] || '';
  const soHoaDon = row[4] || '';

  row[1] = `${datePart}_${maDonVi}_${kyHieu}_${soHoaDon}`; // cột 2

  // Đảm bảo đủ cột
  const excelRow = [];
  for (let i = 0; i < headers.length; i++) {
    excelRow[i] = row[i] || '';
  }

  data.push(excelRow);
});


  // Tạo workbook & sheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = headers.map(() => ({ wch: 25 }));

  XLSX.utils.book_append_sheet(wb, ws, 'Danh_sach_hoa_don');
  XLSX.writeFile(wb, 'Danh_sach_hoa_don.xlsx');
});
