{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<div class="container py-5">
  <div class="card p-4">
    <h2 class="mb-4">➕ Tạo phiếu xuất</h2>

    <form method="post" action="{% url 'create_export_order' %}">
      {% csrf_token %}
      
<!-- Thông tin khách hàng -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Thông tin khách hàng</h5>
  </div>
  <div class="card-body">
    <p><strong>MST:</strong></p>
    <input type="text" name="mst" id="mst-input" class="form-control mb-2" placeholder="Nhập MST">

    <p><strong>Khách hàng:</strong></p>
    <input type="text" name="khach_hang" id="khach-hang-input" class="form-control mb-2" placeholder="Tên khách hàng">

    <p><strong>Địa chỉ:</strong></p>
    <input type="text" name="dia_chi" id="dia-chi-input" class="form-control mb-2" placeholder="Địa chỉ">
  </div>
</div>

      <!-- Danh sách mặt hàng -->
      <div id="poItemsContainer">
        <div class="po-item row g-2 mb-2 align-items-center">

          <div class="col-2">
            <input type="text" name="sku[]" class="form-control sku-input" placeholder="SKU">
          </div>

          <div class="col-2">
            <input type="text" name="ten_goi_chung[]" class="form-control ten-goi-chung-input" placeholder="Tên gọi chung">
          </div>

          <div class="col-1">
            <input type="number" name="so_luong[]" class="form-control qty-input" placeholder="SL" min="1" required>
          </div>

          <div class="col-1">
            <input type="number" name="don_gia[]" class="form-control price-input" placeholder="Đơn giá" min="0" step="0.01" required>
          </div>

        <div class="col-1">
        <select name="thue_suat[]" class="form-control tax-input">
            <option value="0">0%</option>
            <option value="5">5%</option>
            <option value="8">8%</option>
            <option value="10">10%</option>
        </select>
        </div>


          <div class="col-2">
            <input type="number" name="thanh_tien[]" class="form-control amount-input" placeholder="Thành tiền" readonly>
          </div>

          <div class="col-2">
            <input type="number" name="thue_tien[]" class="form-control tax-amount-input" placeholder="Thuế tiền" readonly>
          </div>

          <div class="col-auto">
            <button type="button" class="btn btn-danger btn-sm removeItemBtn">❌</button>
          </div>

        </div>
      </div>

      <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="addItemBtn">+ Thêm mặt hàng</button>

      <!-- Tổng cộng -->
      <div class="mt-3">
        <div class="row g-2">
          <div class="col-3">
            <label class="form-label fw-bold">Tổng thành tiền:</label>
            <input type="number" id="totalAmount" class="form-control" readonly>
          </div>
          <div class="col-3">
            <label class="form-label fw-bold">Tổng thuế:</label>
            <input type="number" id="totalTax" class="form-control" readonly>
          </div>
          <div class="col-3">
            <label class="form-label fw-bold">Tổng cộng:</label>
            <input type="number" id="grandTotal" class="form-control" readonly>
          </div>
        </div>
      </div>

      <div class="mt-3 text-end">
        <button type="submit" class="btn btn-success px-4">✔ Tạo phiếu xuất</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Thêm/xóa dòng
document.getElementById('addItemBtn').addEventListener('click', () => {
  const container = document.getElementById('poItemsContainer');
  const newItem = container.querySelector('.po-item').cloneNode(true);
  newItem.querySelectorAll('input').forEach(input => input.value = '');
  container.appendChild(newItem);
  attachCalcListeners(newItem);
});

document.getElementById('poItemsContainer').addEventListener('click', (e) => {
  if (e.target.classList.contains('removeItemBtn')) {
    const container = document.getElementById('poItemsContainer');
    if (container.querySelectorAll('.po-item').length > 1) {
      e.target.closest('.po-item').remove();
      calculateTotals();
    }
  }
});

// Tính toán
function calculateLine(row) {
  const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
  const price = parseFloat(row.querySelector('.price-input').value) || 0;
  const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;

  const amount = qty * price;
  const taxAmount = amount * taxRate / 100;

  row.querySelector('.amount-input').value = amount.toFixed(2);
  row.querySelector('.tax-amount-input').value = taxAmount.toFixed(2);
}

function calculateTotals() {
  let totalAmount = 0;
  let totalTax = 0;

  document.querySelectorAll('.po-item').forEach(row => {
    const amount = parseFloat(row.querySelector('.amount-input').value) || 0;
    const tax = parseFloat(row.querySelector('.tax-amount-input').value) || 0;
    totalAmount += amount;
    totalTax += tax;
  });

  document.getElementById('totalAmount').value = totalAmount.toFixed(2);
  document.getElementById('totalTax').value = totalTax.toFixed(2);
  document.getElementById('grandTotal').value = (totalAmount + totalTax).toFixed(2);
}

// Gắn sự kiện input để tính tự động
function attachCalcListeners(row) {
  ['.qty-input', '.price-input', '.tax-input'].forEach(selector => {
    row.querySelector(selector).addEventListener('input', () => {
      calculateLine(row);
      calculateTotals();
    });
  });
}

// Gắn listener cho dòng hiện tại
document.querySelectorAll('.po-item').forEach(row => attachCalcListeners(row));

</script>

<!-- Autocomplete SKU -->
<script src="{% static 'js/dmhh.js' %}"></script>
<script src="{% static 'js/dmkh.js' %}"></script>


{% endblock %}
