{% extends 'base.html' %}
{% load humanize %}

{% block container_class %}container-fluid p-0 full-screen-container{% endblock %}
{% block navbar_title %}üì¶ B√°o c√°o Xu·∫•t - Nh·∫≠p - T·ªìn{% endblock %}

<style>
html, body { height: 100%; margin: 0; padding: 0; }

.container-fluid { padding: 0 !important; }
.card { border-radius: 0 !important; border: none !important; }
.full-screen-container { height: 100vh; display: flex; flex-direction: column; }

.card-body-wrapper {
  flex: 1 1 0;
  display: flex;
  flex-direction: column;
  min-height: 0;
}


form.search-form { flex: 0 0 auto; margin-bottom: 8px; }
.pagination-container { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-top: 8px; }

.table-container {
  flex: 1 1 0;
  overflow: auto;
  min-height: 0;
}

/* Pagination lu√¥n hi·ªán */
.pagination-wrapper {
  flex: 0 0 auto;
  padding: 6px 8px;
  background: #fff;
  border-top: 1px solid #ddd;
}


.table-container table {
  border-collapse: collapse;
  width: max-content;
}

.table thead th {
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 10;
}

.table th:first-child,
.table td:first-child {
  position: sticky;
  left: 0;
  background: #fff;
  z-index: 11;
}

.table th, .table td { padding: 6px 8px !important; font-size: 13px; }
.truncate-cell { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.table-sm-custom td,
.table-sm-custom th { font-size: 11px !important; padding: 4px 6px !important; }

.full-height-card { height: 80vh; }
</style>

{% block content %}

<div class="card shadow-sm d-flex flex-column" style="height: 90vh;">
  <div class="pagination-wrapper">
    {% include "components/pagination.html" with page_obj=page_obj %}

  </div>
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <a href="{% url 'inventory_summary_export' %}?search={{ search }}" class="btn btn-success btn-sm">üì• Xu·∫•t Excel</a>
  </div>

  <div class="card-body-wrapper d-flex flex-column" style="min-height:0; height:100%;">
    <form class="search-form row g-2 align-items-center flex-shrink-0 mb-2">
      <div class="col">
        <input type="text" name="search" value="{{ search }}" placeholder="T√¨m ki·∫øm h√†ng h√≥a..." class="form-control form-control-sm">
      </div>
      <div class="col-auto">
        <select name="per_page" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10 / trang</option>
          <option value="20" {% if per_page == 20 %}selected{% endif %}>20 / trang</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50 / trang</option>
          <option value="100" {% if per_page == 100 %}selected{% endif %}>100 / trang</option>
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-primary btn-sm">üîç T√¨m</button>
      </div>
    </form>

    <div class="table-container flex-grow-1" style="overflow:auto; min-height:0;">
      <table class="table table-bordered table-hover table-sm-custom">
        <thead class="table-light">
          <tr>
            <th>TT</th>
            <th>SKU</th>
            <th class="text-center">T√™n g·ªçi chung</th>
            <th>ƒêVT</th>
            <th class="text-center">T·ªïng nh·∫≠p</th>
            <th class="text-center">T·ªïng xu·∫•t</th>
            <th class="text-center">T·ªìn cu·ªëi</th>
            <th class="text-center">Gi√° TB nh·∫≠p</th>
            <th class="text-center">Gi√° TB xu·∫•t</th>
            <th class="text-center">Chi ti·∫øt</th>
          </tr>
        </thead>
        <tbody>
          <tr class="table-secondary fw-bold text-end">
            <td colspan="4" class="text-center">T·ªïng c·ªông</td>
            <td class="text-end">{{ totals.tong_nhap|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ totals.tong_xuat|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ totals.ton_cuoi|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ totals.gia_tb_nhap|intcomma }}</td>
            <td class="text-end">{{ totals.gia_tb_xuat|intcomma }}</td>
            <td></td>
          </tr>

          {% for row in data %}
          <tr class="{% if row.ton_cuoi < 0 %}table-danger{% endif %}">
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>{{ row.sku }}</td>
            <td class="text-start">{{ row.ten_goi_chung }}</td>
            <td>{{ row.dvt }}</td>
            <td class="text-end">{{ row.tong_nhap|floatformat:1|intcomma }}</td>
            <td class="text-end">{{ row.tong_xuat|floatformat:1|intcomma }}</td>
            <td class="text-end fw-bold">{{ row.ton_cuoi|floatformat:1|intcomma }}</td>
            <td class="text-end">{{ row.gia_tb_nhap|floatformat:1|intcomma}}</td>
            <td class="text-end">{{ row.gia_tb_xuat|floatformat:1|intcomma }}</td>
            <td class="text-center">
              {% if row.chi_tiet_nhap or row.chi_tiet_xuat %}
              <button class="btn btn-sm btn-outline-info" data-idx="{{ forloop.counter }}" onclick="toggleDetail(this.dataset.idx)">üëÅÔ∏è</button>
              {% else %}
              <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
          </tr>

          <tr id="detail-{{ forloop.counter }}" class="d-none bg-light">
            <td colspan="11" class="p-2">
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0 text-center">
                  <thead class="table-secondary">
                    <tr>
                      <th>M√£ phi·∫øu</th>
                      <th>Ng√†y</th>
                      <th>ƒê∆°n gi√°</th>
                      <th>S·ªë l∆∞·ª£ng nh·∫≠p</th>
                      <th>S·ªë l∆∞·ª£ng xu·∫•t</th>
                      <th>Th√†nh ti·ªÅn nh·∫≠p</th>
                      <th>Th√†nh ti·ªÅn xu·∫•t</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ct in row.chi_tiet_nhap %}
<tr>
  <td>{{ ct.ma_po }}</td>
  <td>{{ ct.ngay|date:"d/m/Y" }}</td>

  <!-- ƒê∆°n gi√° nh·∫≠p -->
<td class="text-end">
  {{ ct.don_gia|floatformat:2|intcomma }}
</td>

  <td class="text-end">{{ ct.so_luong|floatformat:2|intcomma }}</td>
  <td>‚Äî</td>
  <td class="text-end">{{ ct.thanh_tien|intcomma }}</td>
  <td>‚Äî</td>
</tr>
{% endfor %}

                    {% for ct in row.chi_tiet_xuat %}
<tr>
  <td>{{ ct.ma_po }}</td>
  <td>{{ ct.ngay|date:"d/m/Y" }}</td>
  <td class="text-end">{{ ct.don_gia|floatformat:2|intcomma }}</td>
  <td>‚Äî</td>
  <td class="text-end">{{ ct.so_luong|floatformat:2|intcomma }}</td>
  <td>‚Äî</td>
  <td class="text-end">{{ ct.thanh_tien|intcomma }}</td>
</tr>
{% endfor %}

                  </tbody>
                </table>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="10" class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>



  </div>
</div>

<script>
function toggleDetail(idx) {
  const row = document.getElementById("detail-" + idx);
  if (row) row.classList.toggle("d-none");
}
</script>

{% endblock %}
