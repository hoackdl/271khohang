{% extends "base.html" %}

{% load static %}
{% load humanize %}

{% block container_class %}container-fluid p-0 full-screen-container{% endblock %}

<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* KH√îNG CU·ªòN TO√ÄN TRANG */
}

.full-screen-container {
    height: 85vh; /* 85% viewport */
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
}

/* Card th√¥ng tin PO ‚Äì co theo n·ªôi dung */
.card-po-info {
    flex: 0 0 auto;
}

/* Card b·∫£ng h√†ng h√≥a ‚Äì chi·∫øm ph·∫ßn c√≤n l·∫°i */
.card-po-items {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    min-height: 0; /* quan tr·ªçng ƒë·ªÉ con flex cu·ªôn */
}

/* Table wrapper ‚Äì cu·ªôn b√™n trong card */
.table-scroll {
    flex: 1 1 auto;
    min-height: 0; /* b·∫Øt bu·ªôc ƒë·ªÉ flex cu·ªôn */
    overflow-y: auto;
    border: 1px solid #ddd;
}



/* Table scroll */
.table-scroll {
    flex: 1 1 auto;
    overflow-y: auto;
    min-height: 0;
    border: 1px solid #ddd;
}

/* Sticky header */
.table thead th {
    position: sticky;
    top: 0;
    background: #f1f4ff;
    z-index: 10;
}
</style>

{% block content %}

<div class="full-screen-container">
    <h5 class="mb-3 text-primary">üßæ Ch·ªânh s·ª≠a Phi·∫øu nh·∫≠p X (PO)</h5>

    <!-- Card th√¥ng tin PO -->
    <div class="card card-po-info shadow-sm border-primary">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <p><strong>üìå M√£ PO:</strong> {{ po.po_number }}</p>
                    <p><strong>üìù M·∫´u s·ªë:</strong> {{ po.invoice.mau_so }}</p>
                    <p><strong>üîñ K√Ω hi·ªáu:</strong> {{ po.invoice.ky_hieu }}</p>
                    <p><strong>üìÑ S·ªë h√≥a ƒë∆°n:</strong> {{ po.invoice.so_hoa_don }}</p>
                    <p><strong>üìÖ Ng√†y h√≥a ƒë∆°n:</strong> {{ po.invoice.ngay_hd|date:"d/m/Y" }}</p>
                </div>
                <div class="col-md-4 mb-3">
                    <p><strong>üè∑Ô∏è M√£ s·ªë thu·∫ø:</strong> {{ po.invoice.ma_so_thue }}</p>
                    <p><strong>üè≠ Nh√† cung c·∫•p:</strong> {{ po.supplier }}</p>
                    <p><strong>üìç ƒê·ªãa ch·ªâ:</strong> {{ po.invoice.dia_chi }}</p>
                </div>
                <div class="col-md-4 mb-3">
                    <p><strong>üè∑Ô∏è M√£ s·ªë thu·∫ø:</strong> {{ po.invoice.ma_so_thue_mua }}</p>
                    <p><strong>üë§ Kh√°ch h√†ng:</strong> {{ po.invoice.ten_nguoi_mua }}</p>
                    <p><strong>üìç ƒê·ªãa ch·ªâ:</strong> {{ po.invoice.dia_chi_mua }}</p>
                </div>
            </div>
        </div>
    </div>
<form method="post" action="{% url 'edit_purchase_order' po.id %}">
    {% csrf_token %}
    <!-- Card b·∫£ng h√†ng h√≥a -->
    <div class="card card-po-items shadow-sm border-secondary">
        <div class="table-scroll">
            <table class="table table-bordered table-striped align-middle text-center">
                <thead class="table-primary">
                    <tr>
                        <th>#</th>
                        <th>T√™n h√†ng</th>
                        <th>SKU</th>
                        <th>T√™n g·ªçi chung</th>
                        <th>ƒêVT</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Slg quy ƒë·ªïi</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th>Chi·∫øt kh·∫•u</th>
                        <th>TL CK (%)</th>
                        <th>Th√†nh ti·ªÅn sau CK</th>
                        <th>Thu·∫ø su·∫•t (%)</th>
                        <th>Ti·ªÅn thu·∫ø</th>
                        <th>Thanh to√°n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td class="text-start">{{ item.product_name }}</td>
                        <td>
                            <input type="text" name="sku_{{ item.id }}" class="form-control text-center sku-input" value="{{ item.sku_auto }}" placeholder="Nh·∫≠p SKU">
                        </td>
                        <td>
                            <textarea name="ten_goi_chung_{{ item.id }}" class="form-control" rows="2">{{ item.ten_goi_chung_auto }}</textarea>
                        </td>
                        <td>{{ item.unit }}</td>
                        <td><input type="number" step="1" name="so_luong_{{ item.id }}" class="form-control text-end qty-input" value="{{ item.quantity }}"></td>
                        <td><input type="number" step="1" name="so_luong_quy_doi_{{ item.id }}" class="form-control text-end" value="{{ item.so_luong_quy_doi }}"></td>
                        <td><input type="text" name="don_gia_{{ item.id }}" class="form-control text-end price-input" value="{{ item.unit_price|floatformat:0 }}"></td>
                        <td class="text-end total-cell">{{ item.total_price|floatformat:0|intcomma }}</td>
                        <td><input type="text" name="chiet_khau_{{ item.id }}" class="form-control text-end" value="{{ item.chiet_khau|default_if_none:0 }}"></td>
                        <td><input type="text" name="tl_ck_{{ item.id }}" class="form-control text-end" value="{{ item.tl_ck|default_if_none:0 }}"></td>
                        <td class="text-end">{{ item.total_after_discount|floatformat:0|intcomma }}</td>
                        <td class="text-end" data-tax-rate="{{ item.thue_suat_field }}">{{ item.thue_suat_field }}</td>
                        <td class="text-end tax-cell">{{ item.tien_thue_field|floatformat:0|intcomma }}</td>
                        <td class="text-end">{{ item.final_amount|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-secondary fw-bold">
                        <td colspan="8" class="text-end">T·ªïng c·ªông:</td>
                        <td id="total_sum" class="text-end">{{ po.total_amount|floatformat:0|intcomma }}</td>
                        <td id="total_discount_sum" class="text-end">{{ po.total_discount|floatformat:0|intcomma }}</td>
                        <td>-</td>
                        <td id="total_after_discount_sum" class="text-end">{{ po.total_amount|floatformat:0|intcomma }}</td>
                        <td>-</td>
                        <td id="tax_sum" class="text-end">{{ po.total_tax|floatformat:2|intcomma }}</td>
                        <td id="final_sum" class="text-end">{{ po.total_final_amount|floatformat:0|intcomma }}</td>
                    </tr>
                </tbody>

            </table>
        </div>
    </div>

    <!-- Form submit -->
    
    <div class="d-flex justify-content-between align-items-center mt-2">
        <a href="{% url 'export_order_list' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Quay l·∫°i</a>
        <div>
            <button type="submit" id="save-btn" class="btn btn-success px-4"><i class="bi bi-save"></i> L∆∞u thay ƒë·ªïi</button>
            <button type="button" id="edit-btn" class="btn btn-primary px-4" style="display:none;"><i class="bi bi-pencil"></i> Ch·ªânh s·ª≠a</button>
        </div>
    </div>
</div>
</form>
<script src="{% static 'js/dmhh.js' %}"></script>

{% endblock %}