{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block container_class %}container-fluid p-0 full-screen-container{% endblock %}
{% block navbar_title %}üìã Danh s√°ch kh√°ch h√†ng{% endblock %}

{% block extra_head %}
<style>
.full-screen-container {
    height: 90vh;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    overflow: hidden;
}

.card {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
}

.customer-header,
.list-group-item {
    display: grid;
    grid-template-columns: 0.5fr 3fr 3fr 2fr 2fr 2fr auto;
    gap: 10px;
    align-items: center;
}

.customer-list-scroll {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    border-top: 1px solid #e0e0e0;
}

.list-group-item {
    padding: 10px 0;
    cursor: pointer;
}

.text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.customer-actions a {
    margin-right: 5px;
    white-space: nowrap;
}

/* Responsive */
@media (max-width: 768px) {
    .customer-header,
    .list-group-item {
        grid-template-columns: 2fr 2fr 1fr auto;
        font-size: 14px;
    }
}
</style>
{% endblock extra_head %}

{% block content %}
<div class="full-screen-container">

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
        <!-- N√∫t th√™m kh√°ch h√†ng -->
        <a href="{% url 'customer_add' %}" class="btn btn-success flex-shrink-0">‚ûï Th√™m kh√°ch h√†ng</a>

        <!-- Form t√¨m ki·∫øm -->
        <form method="get" class="d-flex flex-grow-1 gap-2 mb-0">
            <input type="text" name="search_customer" value="{{ search_customer }}" class="form-control" placeholder="T√¨m ki·∫øm...">
            <button type="submit" class="btn btn-outline-primary">T√¨m</button>
        </form>
    </div>

    <!-- Header c·ªôt -->
    <div class="customer-header text-center mb-2 pb-2 border-bottom">
        <div>TT</div>
        <div class="text-start">T√™n kh√°ch h√†ng</div>
        <div class="text-start">ƒê·ªãa ch·ªâ</div>
        <div class="text-center">MST</div>
        <div class="text-center">Nh√≥m</div>
        <div class="text-center">ƒê√£ thu / T·ªïng ti·ªÅn (%)</div>
        <div class="text-center">H√†nh ƒë·ªông</div>
    </div>

    <!-- Danh s√°ch kh√°ch h√†ng c√≥ scroll -->
    <div class="customer-list-scroll">
        <ul class="list-group">
            {% for customer in customers %}
            <li class="list-group-item customer-row" data-customer-id="{{ customer.id }}">
                <!-- S·ªë th·ª© t·ª± theo trang -->
                <div class="text-center">
                    {{ forloop.counter0|add:customers.start_index }}
                </div>

                <div class="text-start text-wrap">{{ customer.ten_khach_hang }}</div>
                <div class="text-start text-wrap">{{ customer.dia_chi }}</div>
                <div class="text-center">{{ customer.ma_so_thue }}</div>
                <div class="text-center">{{ customer.phan_loai }}</div>
               
                <div class="text-center">
                    <span class="text-success">{{ customer.total_paid_calc|floatformat:0|intcomma }}</span> /
                    <span class="text-muted">{{ customer.total_invoice_calc|floatformat:0|intcomma }}</span>
                    ({{ customer.percent_paid_calc|floatformat:0|intcomma }}%)
                </div>

                <div class="customer-actions text-center">
                    <a href="{% url 'customer_detail' customer.id %}" class="btn btn-sm btn-outline-primary">C√¥ng n·ª£</a>
                    <a href="{% url 'customer_edit' customer.pk %}" class="btn btn-sm btn-outline-primary">S·ª≠a</a>
                    <a href="{% url 'customer_delete' customer.pk %}" class="btn btn-sm btn-danger">üóëÔ∏è X√≥a</a>
                </div>
            </li>
            {% empty %}
            <li class="list-group-item text-center">Ch∆∞a c√≥ kh√°ch h√†ng n√†o.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Pagination -->
    {% if customers.has_other_pages %}
    <nav class="mt-3">
        <ul class="pagination justify-content-center">
            {% if customers.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ customers.previous_page_number }}&{{ query_params }}">&laquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for i in customers.paginator.page_range %}
                {% if i >= customers.number|add:-2 and i <= customers.number|add:2 or i == 1 or i == customers.paginator.num_pages %}
                <li class="page-item {% if customers.number == i %}active{% endif %}">
                    {% if customers.number == i %}
                        <span class="page-link">{{ i }}</span>
                    {% else %}
                        <a class="page-link" href="?page={{ i }}&{{ query_params }}">{{ i }}</a>
                    {% endif %}
                </li>
                {% endif %}
            {% endfor %}

            {% if customers.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ customers.next_page_number }}&{{ query_params }}">&raquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

</div>




<script>
document.querySelectorAll('.list-group-item').forEach(row => {
    row.addEventListener('click', () => {
        const customerId = row.dataset.customerId;

        fetch(`/invoice/customers/${customerId}/detail/`)
            .then(res => res.text())
            .then(html => {
                document.getElementById('customerDetailContent').innerHTML = html;
                new bootstrap.Modal(document.getElementById('customerDetailModal')).show();
            });
    });
});
</script>

{% endblock content %}
