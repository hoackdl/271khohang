{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <h2 class="mb-4">üìÇ T·∫£i h√≥a ƒë∆°n XML</h2>

  {% if messages %}
    <div>
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="mb-5">
    {% csrf_token %}
    {{ form.file }}
    <button type="submit" class="btn btn-primary">T·∫£i l√™n</button>
  </form>

  <a href="{% url 'invoice_list' %}">‚¨ÖÔ∏è Danh m·ª•c h√≥a ƒë∆°n</a>

  {% if invoice %}
    <!-- üßæ Th√¥ng tin h√≥a ƒë∆°n -->
    <h5 class="mt-4 mb-2 fw-bold">üßæ Th√¥ng tin h√≥a ƒë∆°n</h5>
    <table class="table table-sm table-bordered">
      <tbody>
        <tr>
          <th width="20%">S·ªë h√≥a ƒë∆°n</th>
          <td>{{ invoice.so_hoa_don }}</td>
          <th>Ng√†y l·∫≠p</th>
          <td>{{ invoice.ngay_hd }}</td>
        </tr>
        <tr>
          <th>H√¨nh th·ª©c thanh to√°n</th>
          <td>{{ invoice.hinh_thuc_tt }}</td>
          <th>M·∫´u s·ªë - K√Ω hi·ªáu</th>
          <td>{{ invoice.mau_so }} - {{ invoice.ky_hieu }}</td>
        </tr>
      </tbody>
    </table>

    <!-- üè¢ Ng∆∞·ªùi b√°n -->
    <h5 class="mt-4 mb-2 fw-bold">üè¢ Ng∆∞·ªùi b√°n</h5>
    <table class="table table-sm table-bordered">
      <tbody>
        <tr>
          <th width="20%">T√™n ƒë∆°n v·ªã</th>
          <td>{{ invoice.ten_dv_ban }}</td>
          <th>M√£ s·ªë thu·∫ø</th>
          <td>{{ invoice.ma_so_thue }}</td>
        </tr>
        <tr>
          <th>ƒê·ªãa ch·ªâ</th>
          <td colspan="3">{{ invoice.dia_chi }}</td>
        </tr>
      </tbody>
    </table>

    <!-- üßç‚Äç‚ôÇÔ∏è Ng∆∞·ªùi mua -->
    <h5 class="mt-4 mb-2 fw-bold">üßç‚Äç‚ôÇÔ∏è Ng∆∞·ªùi mua</h5>
    <table class="table table-sm table-bordered">
      <tbody>
        <tr>
          <th width="20%">T√™n ng∆∞·ªùi mua</th>
          <td>{{ invoice.ten_nguoi_mua }}</td>
          <th>M√£ s·ªë thu·∫ø</th>
          <td>{{ invoice.ma_so_thue_mua }}</td>
        </tr>
        <tr>
          <th>ƒê·ªãa ch·ªâ</th>
          <td>{{ invoice.dia_chi_mua }}</td>
          <th>S·ªë TK / Ng√¢n h√†ng</th>
          <td>{{ invoice.so_tk }} - {{ invoice.ten_ngan_hang }}</td>
        </tr>
      </tbody>
    </table>

    <!-- üì¶ H√†ng h√≥a -->
    <h5 class="mt-4 mb-2 fw-bold">üì¶ H√†ng h√≥a</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle">
        <thead class="table-light text-center">
          <tr>
            <th>STT</th>
            <th>T√™n h√†ng h√≥a</th>
            <th>ƒêVT</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>ƒê∆°n gi√°</th>
            <th>Th√†nh ti·ªÅn</th>
            <th>Thu·∫ø su·∫•t</th>
            <th>Ti·ªÅn thu·∫ø</th>
            <th>Thanh to√°n</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td class="text-center">{{ item.stt }}</td>
            <td>{{ item.ten_hang }}</td>
            <td class="text-center">{{ item.dvt }}</td>
            <td class="text-end">{{ item.so_luong|floatformat:0|intcomma }}</td>
            <td class="text-end">{{ item.don_gia|floatformat:0|intcomma }}</td>
            <td class="money">{{ item.thanh_tien|floatformat:0|intcomma }}</td>
            <td class="text-center">{{ item.thue_suat }}</td>
            <td class="money">{{ item.tien_thue|floatformat:0|intcomma }}</td>
            <td class="money">{{ item.thanh_toan|floatformat:0|intcomma }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="8" class="text-end">T·ªïng thanh to√°n</th>
            <th class="money">{{ invoice.tong_tien|floatformat:0|intcomma }}</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- üíæ Form l∆∞u -->
    <form method="post" action="{% url 'save_invoice' %}">
      {% csrf_token %}
      <input type="hidden" name="invoice_data" id="invoice_data_input">
      <input type="hidden" name="items_data" id="items_data_input">
      <input type="hidden" name="file_name" value="{{ file_name }}">
      <button type="submit" class="btn btn-success mt-3">üíæ L∆∞u v√†o danh m·ª•c h√≥a ƒë∆°n</button>
    </form>
  {% endif %}

  {% if invoice %}
    {{ invoice|json_script:"invoice_data" }}
    {{ items|json_script:"items_data" }}
  {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="{% static 'js/saveinvoice.js' %}"></script>
  <script src="{% static 'js/invoice.js' %}"></script>
{% endblock %}
