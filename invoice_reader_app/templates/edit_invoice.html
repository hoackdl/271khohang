{% extends 'base.html' %}
{% load static %}

{% load static humanize number_to_text %}
{% block container_class %}container-fluid p-0 full-screen-container{% endblock %}

{% block navbar_title %}
üì¶ ‚úèÔ∏è Ch·ªânh s·ª≠a ho√° ƒë∆°n s·ªë <strong>{{ invoice.so_hoa_don }}</strong>
{% endblock %}

{% block content %}

<style>
body, html { height: 100%; }
.full-screen-container { height: 100vh; display: flex; flex-direction: column; }

/* ======= FORM CARD (NH·ªé G·ªåN) ======= */
.small-card .form-label { font-size: 12px !important; }
.small-card input, .small-card select, .small-card textarea { padding: 3px 6px !important; font-size: 13px !important; }
.small-card .card-body { padding: 10px !important; }
.small-card .card-header { padding: 6px 10px !important; font-size: 14px !important; }

/* ======= TABLE ======= */
.table td, .table th { padding: 6px 8px !important; font-size: 13px !important; }
.wrap-text { white-space: normal !important; word-break: break-word !important; }
.table input, .table select { font-size: 13px !important; padding: 3px 6px !important; }
.table td input[type="number"], .text-end { text-align: right !important; }
.table tbody tr:hover { background-color: #f4f9ff !important; }

/* Buttons */
.btn { border-radius: 6px !important; }

/* ======= PRINT ======= */
@media print {
  body * { visibility: hidden; }
  #print-quotation, #print-quotation * { visibility: visible; }
  #print-quotation { position: absolute; left: 0; top: 0; width: 100%; font-size: 12px; font-family: Arial, sans-serif; }
  table { border-collapse: collapse; width: 100%; }
  table th, table td { border: 1px solid #000; padding: 5px; }
  tr { page-break-inside: avoid; }
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
}
#print-quotation table {
  width: 100%;
  max-width: 190mm; /* ho·∫∑c 18.5cm, ph√π h·ª£p v·ªõi l·ªÅ in A4 */
  margin: 0 auto;
  border-collapse: collapse;
  table-layout: fixed; /* gi√∫p chia ƒë·ªÅu ho·∫∑c theo t·ªâ l·ªá c·ªôt */
  word-wrap: break-word; /* xu·ªëng d√≤ng t·ª´ t·ª´ */
}


/* Khi hi·ªÉn th·ªã b√¨nh th∆∞·ªùng, ·∫©n b·∫£ng t·ªïng c·ªông ri√™ng */
.invoice-total {
  display: none;
}

/* Khi in, b·∫£ng t·ªïng c·ªông ngo√†i table hi·ªÉn th·ªã, 
   d√≤ng t·ªïng c·ªông trong table tbody/tfoot c√≥ th·ªÉ ·∫©n n·∫øu mu·ªën */
@media print {
  .invoice-total {
    display: block;
    page-break-inside: avoid; /* tr√°nh b·ªã chia trang */
  }

  /* N·∫øu mu·ªën ·∫©n tfoot trong in, tr√°nh l·∫∑p */
  .invoice-table tfoot {
    display: none;
  }

  @media print {
    .page-break { 
      page-break-before: always; /* Sang trang m·ªõi khi in */
    }
  }
  /* Hi·ªÉn th·ªã √¥ vu√¥ng tr√™n m√†n h√¨nh */
  .no-print-box {
    border: 1px solid #000;
    width: 30px;
    text-align: center;
  }

  /* Khi in ra gi·∫•y, ·∫©n vi·ªÅn, ch·ªâ gi·ªØ kho·∫£ng tr·ªëng */
  @media print {
    .no-print-box {
      border: none;
      width: 20px; /* ƒëi·ªÅu ch·ªânh cho v·ª´a kho·∫£ng tr·ªëng */
    }
  }


</style>

<div class="full-screen-container">

  <div class="card shadow-lg">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>üìÑ Ch·ªânh s·ª≠a h√≥a ƒë∆°n</span>
      <a href="{% url 'invoice_export_list' %}" class="btn btn-light btn-sm">‚¨ÖÔ∏è Quay l·∫°i</a>
    </div>

    <div class="card-body bg-light">

      <form method="post">
  {% csrf_token %}

  <!-- ================= TH√îNG TIN H√ìA ƒê∆†N ================= -->
  <div class="card mb-3 shadow-sm small-card">
    <div class="card-header bg-info text-white">üßæ Th√¥ng tin h√≥a ƒë∆°n</div>
    <div class="card-body">
      <div class="row gx-2 gy-2">
        {% for field in form %}
        <div class="col-md-4">
          <label class="form-label fw-semibold small mb-1">{{ field.label }}</label>

          <!-- HI·ªÇN TH·ªä -->
          <div class="form-control bg-white border small">
            {{ field.value|default_if_none:"" }}
          </div>

          <!-- FIELD TH·∫¨T (·∫®N) -->
          {{ field.as_hidden }}

          {% if field.errors %}
            <div class="text-danger small">{{ field.errors }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <button type="button" onclick="printQuotation()">üñ®Ô∏è In b·∫£ng b√°o gi√°</button>
  <button type="button" onclick="printDeliveryNote()">üñ®Ô∏è In bi√™n b·∫£n giao nh·∫≠n</button>


  <!-- ================= DANH S√ÅCH H√ÄNG H√ìA ================= -->
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">üì¶ Danh s√°ch h√†ng h√≥a</div>
    <div class="card-body bg-white">

      {{ formset.management_form }}

      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm align-middle text-center">
          <thead class="table-primary">
            <tr>
              <th>T√™n h√†ng</th>
              <th>ƒêVT</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>ƒê∆°n gi√°</th>
              <th>Th√†nh ti·ªÅn</th>
              <th>Thu·∫ø su·∫•t</th>
              <th>Ti·ªÅn thu·∫ø</th>
              <th>Thanh to√°n</th>
            </tr>
          </thead>

          <tbody>
            {% for f in formset %}
            <tr>

              <!-- B·∫ÆT BU·ªòC -->
              {{ f.id }}

              <td class="text-start wrap-text">
                {{ f.ten_hang.value }}
                {{ f.ten_hang.as_hidden }}
              </td>

              <td>
                {{ f.dvt.value }}
                {{ f.dvt.as_hidden }}
              </td>

              <td>{{ f.so_luong }}</td>
              <td>{{ f.don_gia }}</td>
              <td>{{ f.thanh_tien }}</td>
              <td>{{ f.thue_suat }}</td>
              <td>{{ f.tien_thue }}</td>

              <td class="text-end">
                {{ f.thanh_tien.value|add:f.tien_thue.value|default_if_none:"0"|floatformat:0|intcomma }}
              </td>

            </tr>
            {% endfor %}
          </tbody>

          <tfoot>
            <tr class="fw-bold" style="background:#f0f0f0;">
              <td colspan="4" class="text-center">T·ªïng c·ªông</td>
              <td class="text-end">{{ total_thanh_tien|floatformat:0|intcomma }}</td>
              <td></td>
              <td class="text-end">{{ total_tien_thue|floatformat:0|intcomma }}</td>
              <td class="text-end">{{ total_thanh_toan|floatformat:0|intcomma }}</td>
            </tr>
          </tfoot>

        </table>
      </div>
    </div>
  </div>

  <!-- ================= N√öT L∆ØU ================= -->
  <div class="text-end mt-3">
    <button type="submit" class="btn btn-primary px-3">
      üíæ L∆∞u thay ƒë·ªïi
    </button>
    <a href="{% url 'invoice_export_list' %}" class="btn btn-secondary px-3">
      ‚¨ÖÔ∏è Tho√°t
    </a>
  </div>

</form>





  <div id="print-quotation" style="display:none;">

  <!-- N·ªôi dung b·∫£ng b√°o gi√° ·ªü ƒë√¢y -->
  <h3>C√îNG TY TNHH TH∆Ø∆†NG M·∫†I D·ªäCH V·ª§ T√ÇM ANH LOGISTICS</h3>
  <div>ƒê·ªãa ch·ªâ: 139 Th√†nh Th√°i, Ph∆∞·ªùng Di√™n H·ªìng, Tp. H·ªì Ch√≠ Minh</div>
  <div>M√£ s·ªë thu·∫ø: 0314858906</div>
  <hr>
  <h4 style="text-align:center; margin:10px 0;">B·∫¢NG B√ÅO GI√Å ƒê∆†N H√ÄNG</h4>
  <!-- Th√¥ng tin kh√°ch h√†ng -->
<table style="width:100%; margin-bottom:15px; border-collapse: collapse; border:0;">
  <tr>
    <td style="text-align:left; width:30%; border:0;">K√≠nh g·ª≠i qu√Ω kh√°ch h√†ng:</td>
    <td style="text-align:left; border:0;">{{ invoice.ten_nguoi_mua }}</td>
  </tr>
  <tr>
    <td style="text-align:left; border:0;">ƒê·ªãa ch·ªâ s·ªë:</td>
    <td style="text-align:left; border:0;">{{ invoice.dia_chi_mua }}</td>
  </tr>
  <tr>
    <td style="text-align:left; border:0;">ƒêi·ªán tho·∫°i:</td>
    <td style="text-align:left; border:0;">{{ invoice.dien_thoai }}</td>
  </tr>
</table>


 <!-- B·∫£ng h√†ng h√≥a cho m·∫´u in -->
<!-- B·∫£ng h√†ng h√≥a -->
<table class="invoice-table" style="width:100%; border-collapse: collapse;" border="1">
  <thead>
    <tr style="background:#f0f0f0; text-align:center;">
      <th style="width:5%;">TT</th>
      <th style="width:auto;">T√™n h√†ng h√≥a</th>
      <th style="width:5%;">ƒêVT</th>
      <th style="width:5%;">S·ªë l∆∞·ª£ng</th>
      <th style="width:8%;">ƒê∆°n gi√° (VNƒê)</th>
      <th style="width:10%;">Th√†nh ti·ªÅn (VNƒê)</th>
      <th style="width:5%;">Thu·∫ø su·∫•t (%)</th>
      <th style="width:8%;">Ti·ªÅn thu·∫ø (VNƒê)</th>
      <th style="width:13%;">Thanh to√°n (VNƒê)</th>
    </tr>
  </thead>
  <tbody>
    {% for f in formset %}
    <tr>
      <td style="text-align:center;">{{ forloop.counter }}</td>
      <td>{{ f.ten_hang.value }}</td>
      <td style="text-align:center;">{{ f.dvt.value }}</td>
      <td style="text-align:right;">{{ f.so_luong.value|default_if_none:"0"|floatformat:0|intcomma }}</td>
      <td style="text-align:right;">{{ f.don_gia.value|default_if_none:"0"|floatformat:0|intcomma }}</td>
      <td style="text-align:right;">{{ f.thanh_tien.value|default_if_none:"0"|floatformat:0|intcomma }}</td>
      <td style="text-align:right;">{{ f.thue_suat.value|default_if_none:"0"|floatformat:0|intcomma }}</td>
      <td style="text-align:right;">{{ f.tien_thue.value|default_if_none:"0"|floatformat:0|intcomma }}</td>
      <td style="text-align:right;">
        {{ f.thanh_tien.value|add:f.tien_thue.value|default_if_none:"0"|floatformat:0|intcomma }}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- D√≤ng t·ªïng c·ªông ƒë·∫∑t ngo√†i table, ch·ªâ hi·ªÉn th·ªã khi in -->
<div class="invoice-total">
  <table style="width:100%; border-collapse: collapse;" border="1">
    <tr style="background:#f9f9f9; font-weight:bold; text-align:right;">
       <td style="width:5%; border: none"></td> <!-- TT + ch·ªØ T·ªïng c·ªông -->
      <td style="width:auto; border: none; text-align:center;" >T·ªïng c·ªông</td> <!-- T√™n h√†ng -->
      <td style="width:5%; border: none;"></td> <!-- ƒêVT -->
      <td style="width:5%; border: none;"></td> <!-- S·ªë l∆∞·ª£ng -->
      <td style="width:8%; border: none;"></td> <!-- ƒê∆°n gi√° -->
      <td style="width:10%; text-align:right;">{{ total_thanh_tien|floatformat:0|intcomma }}</td> <!-- Th√†nh ti·ªÅn -->
      <td style="width:5%; border: none;"></td> <!-- Thu·∫ø su·∫•t -->
      <td style="width:8%; text-align:right;">{{ total_tien_thue|floatformat:0|intcomma }}</td> <!-- Ti·ªÅn thu·∫ø -->
      <td style="width:13%; text-align:right;">{{ total_thanh_toan|floatformat:0|intcomma }}</td> <!-- Thanh to√°n -->
    </tr>
  </table>

</div>

<p>Ghi ch√∫:</p>
<p>- B·∫£ng b√°o gi√° tr√™n c√≥ hi·ªáu l·ª±c trong v√≤ng 15 ng√†y k·ªÉ t·ª´ ng√†y b√™n b√°n g·ª≠i b√°o gi√° cho b√™n mua. Sau th·ªùi gian n√†y, n·∫øu Qu√Ω kh√°ch h√†ng ch∆∞a x√°c nh·∫≠n ƒë·∫∑t h√†ng cho b√™n B√°n th√¨ s·ªë l∆∞·ª£ng h√†ng h√≥a tr√™n s·∫Ω c√≥ s·ª± thay ƒë·ªïi (n·∫øu c√≥) theo t√¨nh h√¨nh th·ª±c t·∫ø c·ªßa B√™n b√°n.</p>
<p>- B·∫£ng gi√° tr√™n ƒë√£ bao g·ªìm thu·∫ø VAT theo quy ƒë·ªãnh, ph√≠ v·∫≠n chuy·ªÉn trong b√°n k√≠nh 5km t·ª´ C·ª≠a h√†ng c·ªßa B√™n b√°n.</p>



<p style="text-align:right; margin-right:4cm; font-weight:bold; font-size:14px; line-height:1.8;">
  Tp. H·ªì Ch√≠ Minh, ng√†y {{ ngay_tru_3|date:"d" }} th√°ng {{ ngay_tru_3|date:"m" }} nƒÉm {{ ngay_tru_3|date:"Y" }}<br>
  C√îNG TY TNHH TMDV T√ÇM ANH LOGISTICS
</p>

<div id="print-quotation-giao-nhan" style="display:none;">
<div style="margin-top:15px; font-size:14px;">
<hr style="margin:25px 0; border-top:2px dashed #000;">

<h4 style="text-align:center; margin:10px 0;">BI√äN B·∫¢N GIAO NH·∫¨N H√ÄNG H√ìA</h4>
<p style="text-align:right; margin-right:4cm; font-weight:bold; font-size:14px; line-height:1.8;">
  Tp. H·ªì Ch√≠ Minh, ng√†y 
  <input type="text" name="ngay" size="2" class="no-print-box"> 
  th√°ng 
  <input type="text" name="thang" size="2" class="no-print-box"> 
  nƒÉm 
  <input type="text" name="nam" size="4" class="no-print-box">
</p>





<!-- Th√¥ng tin giao ‚Äì nh·∫≠n -->
<table style="width:100%; margin-bottom:15px; border-collapse: collapse; border:0;">
  <tr>
    <td style="width:30%; border:0;">B√™n giao h√†ng:</td>
    <td style="border:0;">C√îNG TY TNHH TMDV T√ÇM ANH LOGISTICS</td>
  </tr>
  <tr>
    <td style="border:0;">ƒê·ªãa ch·ªâ:</td>
    <td style="border:0;">139 Th√†nh Th√°i, Ph∆∞·ªùng Di√™n H·ªìng, Tp. H·ªì Ch√≠ Minh</td>
  </tr>
  <tr>
    <td style="border:0;">B√™n nh·∫≠n h√†ng:</td>
    <td style="border:0;">{{ invoice.ten_nguoi_mua }}</td>
  </tr>
  <tr>
    <td style="border:0;">ƒê·ªãa ch·ªâ nh·∫≠n:</td>
    <td style="border:0;">{{ invoice.dia_chi_mua }}</td>
  </tr>
</table>

<!-- B·∫£ng h√†ng h√≥a gi·ªëng b·∫£ng b√°o gi√° -->
<table style="width:100%; border-collapse: collapse;" border="1">
  <thead>
    <tr style="background:#f0f0f0; text-align:center;">
      <th style="width:10%;">TT</th>
      <th>T√™n h√†ng h√≥a</th>
      <th style="width:15%;">ƒêVT</th>
      <th style="width:15%;">S·ªë l∆∞·ª£ng</th>

      <th style="width:15%;">Ghi ch√∫ </th>

    </tr>
  </thead>
  <tbody>
    {% for f in formset %}
    <tr>
      <td style="text-align:center;">{{ forloop.counter }}</td>
      <td>{{ f.ten_hang.value }}</td>
      <td style="text-align:center;">{{ f.dvt.value }}</td>
      <td style="text-align:right;">{{ f.so_luong.value|default_if_none:"0"|floatformat:0|intcomma }}</td>
      
      <td></td>
    </tr>
    {% endfor %}
  </tbody>
</table>



<!-- Ch·ªØ k√Ω -->
<table style="width:100%; margin-top:25px; text-align:center; font-weight:bold; border-collapse:collapse; border:0;">
  <tr>
    <td style="border:0;">B√äN GIAO H√ÄNG</td>
    <td style="border:0;">B√äN NH·∫¨N H√ÄNG</td>
  </tr>
  <tr>
    <td style="height:20px; border:0;">(K√Ω & ghi r√µ h·ªç t√™n)</td>
    <td style="height:20px; border:0;">(K√Ω & ghi r√µ h·ªç t√™n)</td>
  </tr>
</table>
</div>
</div>



</div>

<script>
function printQuotation() {
  var content = document.getElementById('print-quotation').innerHTML;
  var printWindow = window.open('', '_blank', 'width=900,height=700');
  printWindow.document.open();
  printWindow.document.write(`
  <html>
  <head>
    <title>B·∫£ng b√°o gi√°</title>
    <style>
      body { font-family: Arial, sans-serif; font-size:13px; margin:20px; }
      table { width:100%; border-collapse: collapse; table-layout: fixed; word-wrap: break-word; }
      th, td { border:1px solid #000; padding:5px; }
      th { background:#f0f0f0; text-align:center; }
      td:nth-child(1) { text-align:center; }
      td:nth-child(2) { text-align:left; }
      td:not(:nth-child(1)):not(:nth-child(2)) { text-align:right; }
    </style>
  </head>
  <body>
    ${content}
    <script>
      window.onload = function() { window.print(); window.onafterprint = function(){ window.close(); } }
    <\/script>
  </body>
  </html>
  `);
  printWindow.document.close();
}

function printDeliveryNote() {
  var content = document.getElementById('print-quotation-giao-nhan').innerHTML;
  var printWindow = window.open('', '_blank', 'width=900,height=700');
  printWindow.document.open();
  printWindow.document.write(`
    <html>
    <head>
      <title>Bi√™n b·∫£n giao nh·∫≠n</title>
      <style>
        body { font-family: Arial, sans-serif; font-size:13px; margin:20px; }
        table { width:100%; border-collapse: collapse; table-layout: fixed; word-wrap: break-word; }
        th, td { border:1px solid #000; padding:5px; }
        th { background:#f0f0f0; text-align:center; }
        td:nth-child(1) { text-align:center; }
        td:nth-child(2) { text-align:left; }
        td:not(:nth-child(1)):not(:nth-child(2)) { text-align:right; }
        @media print { .page-break { page-break-before: always; } }
      </style>
    </head>
    <body>
      ${content}
      <script>
        window.onload = function() { window.print(); window.onafterprint = function(){ window.close(); } }
      <\/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}
</script>

{% endblock %}