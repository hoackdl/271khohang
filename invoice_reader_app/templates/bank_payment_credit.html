{% extends 'base.html' %}
{% load humanize %}
{% load static humanize number_to_text %}

{% block navbar_title %}Chi ti·∫øt Bank Payment (CREDIT){% endblock %}
{% block container_class %}container-fluid pt-0 px-3 full-screen-container{% endblock %}

{% block content %}
<div class="full-screen-container">
    <div class="card shadow-lg border-0 h-100">

        <div class="card-header bg-warning-subtle fw-bold d-flex justify-content-between">
            üí∞ GIAO D·ªäCH CREDIT ‚Äì THU TI·ªÄN
            {% if payment.is_locked %}
                <span class="badge bg-danger">ƒê√É KH√ìA S·ªî</span>
            {% endif %}
        </div>

        <div class="card-body">
            <form method="post" id="creditForm">
                {% csrf_token %}

                <!-- ================= SEARCH PO ================= -->
                <div class="mb-3">
                    <label class="fw-bold">üîç T√¨m PO theo MST + S·ªë Hƒê + T√™n kh√°ch h√†ng</label>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <input type="text" id="mst" class="form-control" placeholder="M√£ s·ªë thu·∫ø">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="customerName" class="form-control" placeholder="T√™n kh√°ch h√†ng">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="sohd" class="form-control" placeholder="S·ªë h√≥a ƒë∆°n (000123,000124)">
                        </div>
                        <div class="col-md-3 d-grid">
                            <button type="button" id="searchPO" class="btn btn-outline-primary">T√¨m PO</button>
                        </div>
                    </div>
                    <div id="poInfo" class="alert d-none mt-2"></div>
                </div>

                <!-- ================= PO TABLE ================= -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Danh s√°ch PO xu·∫•t (CREDIT)</label>
                    <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
                        <table class="table table-sm table-bordered table-hover mb-0" id="poTable">
                            <thead class="table-light text-center">
                                <tr>
                                    <th width="40">Ch·ªçn</th>
                                    <th>PO</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>MST</th>
                                    <th>S·ªë h√≥a ƒë∆°n</th>
                                    <th class="text-end">S·ªë ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody id="poTableBody">
                                {% for po in purchase_orders %}
                                    {% if not po.po_number|slice:":2" == "PN" %}
                                    <tr id="poRow_{{ po.id }}">
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   class="po-checkbox"
                                                   name="po_id"
                                                   value="{{ po.id }}"
                                                   data-amount="{{ po.total_payment }}"
                                                   {% if po in payment.purchase_orders.all %}checked{% endif %}
                                                   {% if payment.is_locked %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">{{ po.po_number }}</td>
                                        <td>{{ po.customer.ten_khach_hang|default:"‚Äî" }}</td>
                                        <td class="text-center">{{ po.customer.ma_so_thue|default:"‚Äî" }}</td>
                                        <td class="text-center">{{ po.invoice.so_hoa_don|default:"‚Äî" }}</td>
                                        <td class="text-end">{{ po.total_payment|floatformat:0|intcomma }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <hr>

                <!-- ================= NG√ÄY T·∫†O + T·ªîNG TI·ªÄN + CREDIT ================= -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="fw-bold">üìÖ Ng√†y t·∫°o phi·∫øu</label>
                        <input type="date" name="voucher_date" id="voucherDateInput" class="form-control" value="{{ payment.payment_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold text-primary">T·ªïng ti·ªÅn PO ƒë∆∞·ª£c ch·ªçn</label>
                        <input type="text" id="selectedTotalInput" class="form-control" value="0" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold text-success">üíµ T·ªïng ti·ªÅn CREDIT</label>
                        <input type="hidden" name="credit" value="{{ payment.credit }}">
                        <input type="text" id="creditInput" class="form-control mb-1" value="{{ payment.credit|floatformat:0|intcomma }}" disabled>
                        <small id="creditWarning" class="text-danger d-none">‚ö† S·ªë ti·ªÅn CREDIT kh√°c t·ªïng PO</small>
                        <label class="fw-bold mt-2">Ng√†y giao d·ªãch</label>
                        <input type="date" class="form-control" value="{{ payment.payment_date|date:'Y-m-d' }}" disabled>
                    </div>
                </div>

                <!-- ================= N·ªòI DUNG ================= -->
                <div class="mb-3">
                    <label class="fw-bold">N·ªôi dung</label>
                    <textarea name="content" id="contentInput" rows="1" class="form-control" disabled>{{ payment.content }}</textarea>
                </div>

                <!-- ================= ACTION BUTTON ================= -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'bank_payments_manage' %}" class="btn btn-secondary">Quay l·∫°i</a>
                    {% if not payment.is_locked %}
                    <button type="submit" class="btn btn-warning">üíæ L∆∞u CREDIT</button>
                    {% endif %}
                </div>

            </form>
        </div>
    </div>
</div>

<style>
.full-screen-container { height: 85vh; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const poTableBody = document.getElementById("poTableBody");
    const info = document.getElementById("poInfo");
    const searchBtn = document.getElementById("searchPO");
    const creditInput = document.getElementById("creditInput");
    const creditWarning = document.getElementById("creditWarning");
    const selectedTotalInput = document.getElementById("selectedTotalInput");

    function updateSelectedTotal() {
        let total = 0;
        document.querySelectorAll('.po-checkbox:checked').forEach(cb => {
            total += parseFloat(cb.dataset.amount || 0);
        });
        selectedTotalInput.value = total.toLocaleString('en-US');

        const creditValue = parseFloat(creditInput.value.replace(/,/g, '') || 0);
        creditWarning.classList.toggle("d-none", creditValue === total);
    }

    poTableBody.addEventListener("change", function(e) {
        if (e.target.classList.contains('po-checkbox')) updateSelectedTotal();
    });

    searchBtn.addEventListener("click", function () {
        const mst = document.getElementById("mst").value.trim();
        const sohd = document.getElementById("sohd").value.trim();
        const customerName = document.getElementById("customerName").value.trim();
        if (!mst && !sohd && !customerName) {
            alert("Nh·∫≠p M√£ s·ªë thu·∫ø, S·ªë h√≥a ƒë∆°n ho·∫∑c T√™n kh√°ch h√†ng!");
            return;
        }

        fetch("{% url 'find_po_by_mst_invoice' %}?mst=" + encodeURIComponent(mst) 
              + "&sohd=" + encodeURIComponent(sohd)
              + "&customer_name=" + encodeURIComponent(customerName))
            .then(res => res.json())
            .then(data => {
                poTableBody.innerHTML = "";
                if (!data.found || data.pos.length === 0) {
                    info.className = "alert alert-danger mt-2";
                    info.textContent = "‚ùå Kh√¥ng t√¨m th·∫•y PO ph√π h·ª£p";
                    info.classList.remove("d-none");
                    return;
                }

                info.className = "alert alert-success mt-2";
                info.textContent = `‚úî T√¨m th·∫•y ${data.pos.length} PO`;
                info.classList.remove("d-none");

                data.pos.forEach(po => {
                    const row = document.createElement("tr");
                    row.id = `poRow_${po.id}`;
                    row.innerHTML = `
                        <td class="text-center">
                            <input type="checkbox"
                                   class="po-checkbox"
                                   name="po_id"
                                   value="${po.id}"
                                   data-amount="${po.total_payment || 0}">
                        </td>
                        <td class="text-center">${po.po_number}</td>
                        <td>${po.customer_name || "‚Äî"}</td>
                        <td class="text-center">${po.customer_mst || "‚Äî"}</td>
                        <td class="text-center">${po.so_hoa_don || "‚Äî"}</td>
                        <td class="text-end">${(po.total_payment || 0).toLocaleString('en-US')}</td>

                    `;
                    poTableBody.appendChild(row);
                });
                updateSelectedTotal();
            });
    });

    updateSelectedTotal();
});
</script>
{% endblock %}
